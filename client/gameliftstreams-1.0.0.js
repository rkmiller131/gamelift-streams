!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.gameliftstreams=t():e.gameliftstreams=t()}(self,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{GameLiftStreams:()=>F,VERSION:()=>X,setLogLevel:()=>o});const i="1.0.0";let n="none";function o(e){n=e}function s(e){"debug"===n&&console.debug("[Streaming Debug]: "+e)}function r(e){const t=[[]];for(const i of e.split(/[\r\n]+/))i.startsWith("m=")?t.push([i]):t[t.length-1].push(i);function i(e){if(e>0&&e<t.length){const i=t[e][0].match(/^m=(audio|video)\s/);if(i)return"audio"===i[1]?"audio":"video"}return""}function n(e){if(e>0&&e<t.length){const i=t[e][0].match(/^m=(\S+\s+){3}([\d\s]+)$/);if(i)return i[2].split(/\s+/).map((e=>parseInt(e,10)))}return[]}function o(e,i){if(e>0&&e<t.length)for(const n of t[e]){const e=n.match(/^a=rtpmap:(\d+)\s+(\w+)/);if(e&&parseInt(e[1],10)===i)return e[2].toLowerCase()}return""}function r(e,i,n,o){if(e>0&&e<t.length)for(let s=0;s<t[e].length;++s){const r=t[e][s].match(/^a=fmtp:(\d+)\s+(.*?)$/);if(r&&parseInt(r[1],10)===i){const a=r[2].trim().split(/\s*;\s*/);t[e][s]=`a=fmtp:${i} `+[...a.filter((e=>e!==n&&!e.startsWith(n+"="))),`${n}=${o}`].join(";")}}}s(`parsed offer SDP: found ${t.length} media sections`);let a=!1;for(let e=1;e<t.length;++e){const c=n(e);switch(i(e)){case"audio":s(`parsing audio media section ${e} - formats ${c.join(",")}`);for(const t of c)"opus"===o(e,t)&&(r(e,t,"stereo","1"),s(`modified opus format ${t} in section ${e} for stereo=1`));break;case"video":s(`parsing video media section ${e} - formats ${c.join(",")}`);for(const i of c)"h264"===o(e,i)&&(a=!0,r(e,i,"x-google-max-bitrate","19000"),r(e,i,"x-google-start-bitrate","10000"),s(`modified h264 format ${i} in section ${e} for bitrate`),t[e]=t[e].filter((e=>!e.startsWith("b="))),t[e].push("b=TIAS:19000000"),t[e].push("b=AS:19000"))}}if(!a)throw new Error("Browser does not support H.264 video playback over WebRTC");return t.reduce(((e,t)=>e.concat(t)),[]).join("\n")}function a(e,t,i){c(e,t),t.set(e,i)}function c(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function d(e,t){return e.get(h(e,t))}function l(e,t,i){return e.set(h(e,t),i),i}function h(e,t,i){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:i;throw new TypeError("Private element is not present on this object")}var u=new WeakMap,p=new WeakMap,f=new WeakMap,m=new WeakMap,v=new WeakMap,w=new WeakMap,g=new WeakMap,y=new WeakMap,E=new WeakMap,b=new WeakSet;class C{constructor(e){var t,i,n;c(this,n=b),n.add(this),a(this,u,void 0),a(this,p,void 0),a(this,f,void 0),a(this,m,void 0),a(this,v,void 0),a(this,w,void 0),a(this,g,void 0),a(this,y,void 0),a(this,E,void 0),this.videoElement=e.videoElement,this.audioElement=e.audioElement,this.clientConnection=e.clientConnection,l(u,this,new RTCPeerConnection({iceServers:[]})),l(m,this,!1),d(u,this).ontrack=e=>{"video"===e.track.kind?(l(g,this,e.track),this.videoElement.srcObject!==e.streams[0]&&(this.videoElement.srcObject=e.streams[0],this.videoElement.autoplay&&this.videoElement.play())):"audio"===e.track.kind&&(l(y,this,e.track),this.audioElement.srcObject!==e.streams[0]&&(this.audioElement.srcObject=e.streams[0],this.audioElement.autoplay&&!this.audioElement.muted&&this.audioElement.play()))};const o=null!==(t=null===(i=window)||void 0===i||null===(i=i.navigator)||void 0===i?void 0:i.userAgent)&&void 0!==t?t:"unknown",r=o.includes(" Chrome/"),C=o.includes(" Gecko/");function T(e){return"errorDetail"in e?String(e.errorDetail):"error"in e&&"object"==typeof e.error&&e.error&&"errorDetail"in e.error?String(e.error.errorDetail):"message"in e?String(e.message):"(unknown)"}o.includes(" Safari/")&&!r&&!C&&(d(u,this).addTransceiver("video",{direction:"recvonly"}),d(u,this).addTransceiver("audio",{direction:"recvonly"})),h(b,this,k).call(this),h(b,this,S).call(this),h(b,this,M).call(this),l(p,this,d(u,this).createDataChannel("inputChannel",{ordered:!1,maxRetransmits:0})),d(p,this).binaryType="arraybuffer",d(p,this).addEventListener("open",(()=>{s("Input data channel is now open")})),d(p,this).addEventListener("error",(e=>{s(`Input Data Channel Error details: ${T(e)}`),this.clientConnection.channelError(e)})),l(f,this,d(u,this).createDataChannel("clientMessageChannel",{ordered:!0})),d(f,this).binaryType="arraybuffer",d(f,this).addEventListener("open",(()=>{s("Client message channel is now open")})),d(f,this).addEventListener("error",(e=>{s(`Client Message Data Channel Error details: ${T(e)}`),this.clientConnection.channelError(e)}))}getVideoStats(){return d(v,this)?d(v,this):d(u,this).getStats(d(g,this))}getAudioStats(){return d(w,this)?d(w,this):d(u,this).getStats(d(y,this))}getRTCInterfaces(){return{rtcPeerConnection:d(u,this),rtcDataChannel:d(p,this),rtcClientMessageChannel:d(f,this)}}async enableAudioInputStream(e){l(E,this,await navigator.mediaDevices.getUserMedia({audio:null==e||e})),d(E,this).getTracks().forEach((e=>d(u,this).addTrack(e,d(E,this))))}async generateOffer(e){const t=d(u,this),i=await t.createOffer({offerToReceiveAudio:e,offerToReceiveVideo:!0});if(!i.sdp)throw new Error("Browser does not support initiating WebRTC connections");if(i.sdp=r(i.sdp),d(m,this)){const e=new Promise((e=>{t.onicegatheringstatechange=()=>{"complete"==t.iceGatheringState&&e()},setTimeout(e,15e3)}));if(await t.setLocalDescription(i),await e,!t.localDescription)throw new Error("Browser failed to initiate local WebRTC connection");i.sdp=r(t.localDescription.sdp)}else await t.setLocalDescription(i);return i}setIceServers(e){d(u,this).setConfiguration({iceServers:e}),l(m,this,e.length>0)}async setRemoteDescription(e){const t=new RTCSessionDescription(e);return await d(u,this).setRemoteDescription(t)}close(){d(v,this)||l(v,this,this.getVideoStats()),d(w,this)||l(w,this,this.getAudioStats()),d(f,this)&&(d(f,this).close(),l(f,this,void 0),s("Client message channel closed")),d(p,this)&&(d(p,this).close(),l(p,this,void 0),s("Input data channel closed")),d(u,this)&&(d(u,this).close(),l(u,this,void 0),s("RTCPeerConnection closed")),d(E,this)&&(d(E,this).getTracks().forEach((e=>e.stop())),l(E,this,void 0),s("Stopped media tracks"))}isClosed(){return null==d(u,this)}}function S(){s(`Ice connection state: ${d(u,this).iceConnectionState}`)}function k(){const e=d(u,this);e.addEventListener("connectionstatechange",(()=>{switch(this.clientConnection.connectionState(e.connectionState),e.connectionState){case"connected":s("The peer is fully connected!");break;case"disconnected":case"failed":s("One or more transports has terminated unexpectedly or in an error!");break;case"closed":s("Connection has been closed")}}))}function M(){d(u,this).onicecandidateerror=e=>{e.errorCode>=300&&e.errorCode<=699?s(`ICE candidate error due to STUN error. code: ${e.errorCode} (reference RFC 5389)`):e.errorCode>=700&&e.errorCode<=799&&s(`ICE candidate error due to server error. code: ${e.errorCode} (reference RFC 5389)`)}}function T(e,t,i){I(e,t),t.set(e,i)}function I(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function W(e,t){return e.get(R(e,t))}function D(e,t,i){return e.set(R(e,t),i),i}function R(e,t,i){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:i;throw new TypeError("Private element is not present on this object")}var j=new WeakMap,A=new WeakMap,G=new WeakMap,L=new WeakMap,O=new WeakMap,$=new WeakMap,P=new WeakMap,x=new WeakMap,V=new WeakMap,N=new WeakMap,U=new WeakMap,z=new WeakMap,_=new WeakMap,B=new WeakSet;class F{constructor(e){var t,i,n,o,s,r,a,c,d,l,h;if(I(this,h=B),h.add(this),T(this,j,void 0),T(this,A,void 0),T(this,G,void 0),T(this,L,void 0),T(this,O,void 0),T(this,$,void 0),T(this,P,void 0),T(this,x,void 0),T(this,V,void 0),T(this,N,void 0),T(this,U,void 0),T(this,z,void 0),T(this,_,void 0),!e||"object"!=typeof e){if(!("videoElement"in e))throw new Error("Amazon GameLift Streams constructor argument must be an object with a videoElement property");if(!("audioElement"in e))throw new Error("Amazon GameLift Streams constructor argument must be an object with an audioElement property")}if("VIDEO"!==(null===(t=e.videoElement)||void 0===t?void 0:t.tagName))throw new Error("videoElement property must be a HTML <video> element");if("AUDIO"!==(null===(i=e.audioElement)||void 0===i?void 0:i.tagName))throw new Error("audioElement property must be a HTML <audio> element");D(j,this,function(){const e=new Uint8Array(16);return crypto.getRandomValues(e),[...e].map((function(e){return(e+256).toString(16).slice(-2)})).join("")}()),D(A,this,e.videoElement),D(G,this,e.audioElement),D(L,this,K.call(F,e.inputConfiguration)),D($,this,{connectionState:(null===(n=e.clientConnection)||void 0===n?void 0:n.connectionState)||(e=>{}),channelError:(null===(o=e.clientConnection)||void 0===o?void 0:o.channelError)||(e=>{}),serverDisconnect:(null===(s=e.clientConnection)||void 0===s?void 0:s.serverDisconnect)||(e=>{}),applicationMessage:(null===(r=e.clientConnection)||void 0===r?void 0:r.applicationMessage)||(e=>{})}),D(x,this,null),D(V,this,!1),D(N,this,!1),D(U,this,!1),D(z,this,(null===(a=e.streamConfiguration)||void 0===a?void 0:a.maximumKbps)||0),D(_,this,null===(c=null===(d=e.streamConfiguration)||void 0===d?void 0:d.enableAudio)||void 0===c||c),D(P,this,null===(l=e.streamConfiguration)||void 0===l?void 0:l.iceServers),D(O,this,new C({videoElement:W(A,this),audioElement:W(G,this),clientConnection:W($,this)}))}get id(){return W(j,this)}async enableMicrophone(e){R(B,this,J).call(this),await W(O,this).enableAudioInputStream(e)}async generateSignalRequest(){R(B,this,J).call(this),W(O,this).isClosed()&&(D(N,this,!1),D(O,this,new C({videoElement:W(A,this),audioElement:W(G,this),clientConnection:W($,this)}))),W(O,this).setIceServers(await async function(e){const t=e=>{const t=[];for(const i of e||[])"urls"in i?t.push(i):t.push({urls:i.url,username:i.username,credential:i.credential});return t};if(void 0===e)return[];if(Array.isArray(e))return t(e);const i=e();return Array.isArray(i)?t(i):t(await i)}(W(P,this)));const e=await W(O,this).generateOffer(W(_,this));return JSON.stringify({type:e.type,sdp:e.sdp,webSdkVersion:i,extras:{features:[{name:"WEBRTC_SPLIT_MEDIA_STREAMS",value:"enabled"}]}})}async processSignalResponse(e){let t;R(B,this,J).call(this);try{t=JSON.parse(e)}catch{t=null}if(!("object"==typeof t&&t&&"sdp"in t&&"string"==typeof t.sdp&&"type"in t&&"answer"===t.type&&"webSdkProtocolUrl"in t&&"string"==typeof t.webSdkProtocolUrl))throw new Error("signalResponse JSON could not be parsed or is missing required properties");await R(B,this,H).call(this,t.webSdkProtocolUrl,e),await W(O,this).setRemoteDescription({sdp:t.sdp,type:"answer"}),D(V,this,!0),W(U,this)&&this.attachInput()}attachInput(){R(B,this,q).call(this),W(x,this).attach(),D(U,this,!0)}detachInput(){R(B,this,q).call(this),W(x,this).detach(),D(U,this,!1)}getVideoRTCStats(){return W(O,this).getVideoStats()}getAudioRTCStats(){return W(O,this).getAudioStats()}close(){W(x,this)&&(W(x,this).detach(),D(x,this,null)),W(O,this).close(),D(V,this,!1),D(N,this,!0),D(U,this,!1)}processKeyboardEvent(e){return!!W(x,this)&&!!W(x,this).processKeyboardEvent(e)}processMouseEvent(e){return!!W(x,this)&&!!W(x,this).processMouseEvent(e)}addGamepad(e){return!!W(x,this)&&!!W(x,this).processGamepadEvent(Q("gamepadconnected",{gamepad:e}))}removeGamepad(e){return!!W(x,this)&&!!W(x,this).processGamepadEvent(Q("gamepaddisconnected",{gamepad:e}))}processGamepads(){return!!W(x,this)&&!!W(x,this).pollTrackedGamepads()}sendApplicationMessage(e){return!!W(x,this)&&!!W(x,this).sendApplicationMessage(e)}}function K(e){var t;const i={setCursor:"visibility",autoPointerLock:"fullscreen",resetOnDetach:!0,trackWindowFocus:!0};for(const[t,n]of Object.entries(null!=e?e:{}))void 0!==n&&(i[t]=n);const n=(null===(t=window)||void 0===t||null===(t=t.navigator)||void 0===t?void 0:t.userAgent)||"unknown",o=n.includes(" Chrome/"),s=n.includes(" Gecko/");return n.includes(" Safari/")&&!o&&!s&&(i.autoPointerLock=!1),i}async function H(e,t){if(W(x,this))return;s("Initialize input module"),await async function(e){return new Promise(((t,i)=>{const n=document.createElement("script");n.setAttribute("src",e),n.setAttribute("crossorigin","anonymous"),n.addEventListener("load",(()=>{s("Successfully loaded "+e),t(!0)})),n.addEventListener("error",(()=>{s("Failed to load "+e),i(new Error("Error when loading script "+e))})),document.body.appendChild(n)}))}(e);let n=null;if("GameCastInputModule"in window&&"object"==typeof window.GameCastInputModule&&window.GameCastInputModule&&"GameCastInput"in window.GameCastInputModule&&"function"==typeof window.GameCastInputModule.GameCastInput&&(n=window.GameCastInputModule.GameCastInput),!n)throw new Error("input module not available, dynamic protocol file failed to load");const o={webSdkVersion:i,signalResponse:t,videoElement:W(A,this),inputConfiguration:W(L,this),clientRtc:W(O,this).getRTCInterfaces(),debugLog:s,onServerDisconnect:e=>W($,this).serverDisconnect(e),onApplicationMessageReceived:W($,this).applicationMessage,bitrateMaxKilobits:W(z,this)};D(x,this,new n(o))}function J(){if(W(V,this))throw new Error("This instance is already bound to a stream, call close() and create a new instance")}function q(){if(!W(V,this)||W(N,this))throw new Error("This instance is not currently streaming")}function Q(e,t){const i=new Event(e,t);return i.gamepad=t.gamepad,i}const X=i;return t})()));